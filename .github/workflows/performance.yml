name: Performance Benchmarks & Regression Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master, develop]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            meson ninja-build \
            libgtk-3-dev libcinnamon-desktop-dev libgail-3-dev \
            libxapp-dev libexif-dev libselinux1-dev libexempi-dev libgsf-1-dev
      
      - name: Setup build (PR)
        run: |
          meson setup build-pr
          meson compile -C build-pr
      
      - name: Benchmark PR
        run: |
          bash utils/benchmark-icon-scroll.sh /tmp/benchmark-pr.json
          cat /tmp/benchmark-pr.json
      
      - name: Checkout baseline (main)
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Setup build (baseline)
        run: |
          meson setup build-baseline
          meson compile -C build-baseline
      
      - name: Benchmark baseline
        run: |
          bash utils/benchmark-icon-scroll.sh /tmp/benchmark-baseline.json
          cat /tmp/benchmark-baseline.json
      
      - name: Compare benchmarks
        run: |
          python3 utils/compare-benchmarks.py /tmp/benchmark-baseline.json /tmp/benchmark-pr.json
        continue-on-error: true  # Don't block PR; just report
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: |
            /tmp/benchmark-baseline.json
            /tmp/benchmark-pr.json
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const baseline = JSON.parse(fs.readFileSync('/tmp/benchmark-baseline.json', 'utf8'));
            const pr = JSON.parse(fs.readFileSync('/tmp/benchmark-pr.json', 'utf8'));
            
            let comment = '## Performance Benchmark Results\n\n';
            comment += '| Items | Baseline (ms) | PR (ms) | Delta | Status |\n';
            comment += '|-------|---------------|--------|-------|--------|\n';
            
            let hasRegression = false;
            for (const result of pr.results) {
              const count = result.item_count;
              const prTime = result.startup_time_ms;
              const baselineTime = baseline.results.find(r => r.item_count === count).startup_time_ms;
              const delta = prTime - baselineTime;
              const deltaPct = (delta / baselineTime * 100).toFixed(1);
              const status = deltaPct > 5 ? 'âŒ Regression' : 'âœ… OK';
              if (deltaPct > 5) hasRegression = true;
              comment += `| ${count} | ${baselineTime} | ${prTime} | ${delta > 0 ? '+' : ''}${deltaPct}% | ${status} |\n`;
            }
            
            comment += '\nðŸ“Š [Download detailed results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            meson ninja-build \
            libgtk-3-dev libcinnamon-desktop-dev libgail-3-dev \
            libxapp-dev libexif-dev libselinux1-dev libexempi-dev libgsf-1-dev
      
      - name: Build
        run: |
          meson setup build
          meson compile -C build
      
      - name: Run tests
        run: meson test -C build
